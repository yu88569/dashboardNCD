<script>
  /* ============================================
   Configuration & State
   ============================================ */
  const COL = {
    fname: "‡∏ä‡∏∑‡πà‡∏≠",
    lname: "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•",
    village: "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô",
    house: "‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà",
    province: "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î",
    amphoe: "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠",
    tambon: "‡∏ï‡∏≥‡∏ö‡∏•",
    phone: "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå",
    ncd: "‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏£‡∏Ñ NCDs",
    obesity: "‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô",
    dm: "‡πÇ‡∏£‡∏Ñ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô",
    htn: "‡πÇ‡∏£‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï",
    mental: "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï",
    smoke: "‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà",
    alcohol: "‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå",
    status: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",
    refer: "‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£",
    referCode: "‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å",
  };

  const state = {
    raw: [],
    filtered: [],
    options: { province: [], amphoe: [], tambon: [], status: [] },
    filters: { province: "", amphoe: "", tambon: "", status: "" },
  };

  const $ = (id) => document.getElementById(id);

  /* ============================================
   Theme Management
   ============================================ */
  function initTheme() {
    const saved = localStorage.getItem("theme") || "dark";
    applyTheme(saved);

    const btn = $("theme-toggle");
    btn.addEventListener("click", toggleTheme);
  }

  function applyTheme(theme) {
    if (theme === "light") {
      document.body.classList.add("light-theme");
      $("theme-toggle").textContent = "‚òÄÔ∏è";
    } else {
      document.body.classList.remove("light-theme");
      $("theme-toggle").textContent = "üåô";
    }
    localStorage.setItem("theme", theme);

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    if (window.chTambon) updateChartsTheme();
  }

  function toggleTheme() {
    const isLight = document.body.classList.contains("light-theme");
    applyTheme(isLight ? "dark" : "light");
  }

  function updateChartsTheme() {
    if (window.chTambon) {
      window.chFactors.dispose();
      window.chTambon.dispose();
      window.chSickStatus.dispose();
      window.chRiskStatus.dispose();
      window.chFactors = null;
      window.chTambon = null;
      window.chSickStatus = null;
      window.chRiskStatus = null;
      drawCharts();
    }
  }

  /* ============================================
   Data Management
   ============================================ */
  function load() {
    google.script.run
      .withSuccessHandler(({ data }) => {
        state.raw = data.map((x) => normalize(x));
        computeOptions();
        applyFilters();
      })
      .withFailureHandler((err) => {
        alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
        console.error(err);
      })
      .getDataObj();
  }

  function normalize(x) {
    const t = (v) => (v == null ? "" : String(v).trim());
    return {
      ...x,
      [COL.province]: t(x[COL.province]),
      [COL.amphoe]: t(x[COL.amphoe]),
      [COL.tambon]: t(x[COL.tambon]),
      [COL.ncd]: t(x[COL.ncd]),
      [COL.status]: t(x[COL.status]),
      [COL.phone]: t(x[COL.phone]).replace(/[^\d]/g, "").replace(/^0?/, "0"),
    };
  }

  function computeOptions() {
    const uniq = (arr) =>
      Array.from(new Set(arr.filter(Boolean))).sort((a, b) =>
        a.localeCompare(b, "th")
      );
    state.options.province = uniq(state.raw.map((r) => r[COL.province]));
    state.options.amphoe = uniq(state.raw.map((r) => r[COL.amphoe]));
    state.options.tambon = uniq(state.raw.map((r) => r[COL.tambon]));
    state.options.status = uniq(state.raw.map((r) => r[COL.status]));
    fillSelect("f-province", state.options.province);
    fillSelect("f-amphoe", state.options.amphoe);
    fillSelect("f-tambon", state.options.tambon);
    fillSelect("f-status", state.options.status);
  }

  function fillSelect(id, items) {
    const el = $(id);
    el.innerHTML =
      `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` +
      items.map((x) => `<option>${x}</option>`).join("");
    el.onchange = () => {
      state.filters[id.split("-")[1]] = el.value;
      applyFilters();
    };
  }

  function applyFilters() {
    const f = state.filters;
    state.filtered = state.raw.filter(
      (r) =>
        (!f.province || r[COL.province] === f.province) &&
        (!f.amphoe || r[COL.amphoe] === f.amphoe) &&
        (!f.tambon || r[COL.tambon] === f.tambon) &&
        (!f.status || r[COL.status] === f.status)
    );

    renderKpis();
    renderTable();
    drawCharts();
  }

  /* ============================================
   UI Rendering
   ============================================ */
  function renderKpis() {
    const total = state.filtered.length;
    const ncdRisk = state.filtered.filter((r) =>
      includesThaiRisk(r[COL.ncd])
    ).length;
    const ncdOk = state.filtered.filter((r) => isThaiNormal(r[COL.ncd])).length;
    const finished = state.filtered.filter((r) =>
      (r[COL.status] || "").includes("‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô")
    ).length;

    $("kpi-total").textContent = total;
    $("kpi-risk").textContent = ncdRisk;
    $("kpi-ok").textContent = ncdOk;
    $("kpi-finish").textContent = finished;
    
    // ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
    const normalCount = state.filtered.filter((r) => isThaiNormal(r[COL.ncd])).length;
    const riskCount = state.filtered.filter((r) => includesThaiRisk(r[COL.ncd])).length;
    const sickCount = total - normalCount - riskCount;
    
    $("overview-total").textContent = total;
    $("overview-normal").textContent = normalCount;
    $("overview-risk").textContent = riskCount;
    $("overview-sick").textContent = sickCount;
    
    $("overview-normal-pct").textContent = `(${((normalCount / total * 100) || 0).toFixed(2)}%)`;
    $("overview-risk-pct").textContent = `(${((riskCount / total * 100) || 0).toFixed(2)}%)`;
    $("overview-sick-pct").textContent = `(${((sickCount / total * 100) || 0).toFixed(2)}%)`;
    
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà: ‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà
    const smokeData = state.filtered.map((r) => norm(r[COL.smoke]));
    const smokeNormal = smokeData.filter((s) => s.includes("‡πÑ‡∏°‡πà‡∏™‡∏π‡∏ö") || s === "‡πÑ‡∏°‡πà‡∏™‡∏π‡∏ö").length;
    const smokeRisk = smokeData.filter((s) => s.includes("‡∏™‡∏π‡∏ö") && !s.includes("‡πÑ‡∏°‡πà‡∏™‡∏π‡∏ö")).length;
    
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå: ‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå
    const alcoholData = state.filtered.map((r) => norm(r[COL.alcohol]));
    const alcoholNormal = alcoholData.filter((s) => s.includes("‡πÑ‡∏°‡πà‡∏î‡∏∑‡πà‡∏°") || s === "‡πÑ‡∏°‡πà‡∏î‡∏∑‡πà‡∏°").length;
    const alcoholRisk = alcoholData.filter((s) => s.includes("‡∏î‡∏∑‡πà‡∏°") && !s.includes("‡πÑ‡∏°‡πà‡∏î‡∏∑‡πà‡∏°")).length;
    
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï: ‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï
    const mentalData = state.filtered.map((r) => norm(r[COL.mental]));
    const mentalNormal = mentalData.filter((s) => isThaiNormal(s)).length;
    const mentalRisk = mentalData.filter((s) => includesThaiRisk(s)).length;
    
    $("smoke-normal").textContent = smokeNormal;
    $("smoke-risk").textContent = smokeRisk;
    $("alcohol-normal").textContent = alcoholNormal;
    $("alcohol-risk").textContent = alcoholRisk;
    $("mental-normal").textContent = mentalNormal;
    $("mental-risk").textContent = mentalRisk;
  }

  function isThaiNormal(s) {
    return ["‡∏õ‡∏Å‡∏ï‡∏¥", "‡∏õ‡∏Å‡∏ï‡∏¥ ", " ‡∏õ‡∏Å‡∏ï‡∏¥"].includes((s || "").trim());
  }

  function includesThaiRisk(s) {
    return (s || "").includes("‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á") || (s || "").includes("‡∏™‡∏π‡∏á");
  }

  function renderTable() {
    const tbody = document.querySelector("#tbl tbody");
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ dashboard) ‡∏Å‡πá‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
    if (!tbody) return;
    
    tbody.innerHTML = state.filtered
      .slice(0, 200)
      .map((r) => {
        const n = r[COL.ncd] || "";
        const badge = isThaiNormal(n)
          ? "ok"
          : includesThaiRisk(n)
          ? "warn"
          : "";
        const s = r[COL.status] || "";
        const sbadge = s.includes("‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô") ? "ok" : s ? "warn" : "";
        return `<tr>
        <td>${r[COL.fname] || ""}</td>
        <td>${r[COL.lname] || ""}</td>
        <td>${r[COL.tambon] || ""}</td>
        <td>${r[COL.amphoe] || ""}</td>
        <td>${r[COL.province] || ""}</td>
        <td>${prettyPhone(r[COL.phone])}</td>
        <td><span class="badge ${badge}">${n || "-"}</span></td>
        <td><span class="badge ${sbadge}">${s || "-"}</span></td>
      </tr>`;
      })
      .join("");
  }

  function prettyPhone(p) {
    if (!p) return "-";
    if (p.length === 10)
      return `${p.slice(0, 3)}-${p.slice(3, 6)}-${p.slice(6)}`;
    return p;
  }

  /* ============================================
   Charts
   ============================================ */
  function drawCharts() {
    const el2 = document.getElementById("chart-factors");
    const el3 = document.getElementById("chart-tambon");
    window.chFactors = window.chFactors || echarts.init(el2);
    window.chTambon = window.chTambon || echarts.init(el3);

    const isDark = !document.body.classList.contains("light-theme");
    const textColor = isDark ? "#e7e9ee" : "#1a1d2e";
    const axisLineColor = isDark ? "#1c2342" : "#d1d5db";

    // 1) ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á
    const keys = [
      COL.obesity,
      COL.dm,
      COL.htn,
      COL.mental,
      COL.alcohol,
      COL.smoke,
    ];
    const labels = [
      "‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô",
      "‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô",
      "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô",
      "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï",
      "‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå",
      "‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà",
    ];
    const normal = [],
      risk = [],
      other = [];
    keys.forEach((k, i) => {
      const group = state.filtered.map((r) => norm(r[k]));
      normal.push(group.filter(isThaiNormal).length);
      risk.push(group.filter(includesThaiRisk).length);
      other.push(
        group.filter((s) => s && !isThaiNormal(s) && !includesThaiRisk(s))
          .length
      );
    });
    window.chFactors.setOption({
      tooltip: { trigger: "axis", axisPointer: { type: "shadow" } },
      legend: {
        data: ["‡∏õ‡∏Å‡∏ï‡∏¥", "‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á", "‡∏≠‡∏∑‡πà‡∏ô ‡πÜ"],
        textStyle: { color: textColor },
      },
      textStyle: { color: textColor },
      grid: { left: "3%", right: "4%", bottom: "3%", containLabel: true },
      xAxis: {
        type: "category",
        data: labels,
        axisLabel: { color: textColor },
        axisLine: { lineStyle: { color: axisLineColor } },
      },
      yAxis: {
        type: "value",
        axisLabel: { color: textColor },
        axisLine: { lineStyle: { color: axisLineColor } },
        splitLine: { lineStyle: { color: axisLineColor } },
      },
      series: [
        { name: "‡∏õ‡∏Å‡∏ï‡∏¥", type: "bar", stack: "total", data: normal },
        { name: "‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á", type: "bar", stack: "total", data: risk },
        { name: "‡∏≠‡∏∑‡πà‡∏ô ‡πÜ", type: "bar", stack: "total", data: other },
      ],
    });

    // 2) Top ‡∏ï‡∏≥‡∏ö‡∏•
    const tb = Object.entries(
      countBy(state.filtered, (r) => norm(r[COL.tambon]))
    )
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10);
    window.chTambon.setOption({
      tooltip: { trigger: "axis" },
      textStyle: { color: textColor },
      xAxis: {
        type: "value",
        axisLabel: { color: textColor },
        axisLine: { lineStyle: { color: axisLineColor } },
        splitLine: { lineStyle: { color: axisLineColor } },
      },
      yAxis: {
        type: "category",
        data: tb.map((x) => x[0]).reverse(),
        axisLabel: { color: textColor },
        axisLine: { lineStyle: { color: axisLineColor } },
      },
      series: [{ type: "bar", data: tb.map((x) => x[1]).reverse() }],
    });

    // 3) ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡πà‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏ô‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏Ñ)
    const el4 = document.getElementById("chart-sick-status");
    const el5 = document.getElementById("chart-risk-status");
    window.chSickStatus = window.chSickStatus || echarts.init(el4);
    window.chRiskStatus = window.chRiskStatus || echarts.init(el5);
    
    // ‡∏ô‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏Ñ (‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á = ‡∏õ‡πà‡∏ß‡∏¢)
    const obesitySick = state.filtered.filter((r) => {
      const val = norm(r[COL.obesity]);
      return val.includes("‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á") || val.includes("‡∏õ‡πà‡∏ß‡∏¢");
    }).length;
    
    const dmSick = state.filtered.filter((r) => {
      const val = norm(r[COL.dm]);
      return val.includes("‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á") || val.includes("‡∏õ‡πà‡∏ß‡∏¢");
    }).length;
    
    const htnSick = state.filtered.filter((r) => {
      const val = norm(r[COL.htn]);
      return val.includes("‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á") || val.includes("‡∏õ‡πà‡∏ß‡∏¢");
    }).length;
    
    window.chSickStatus.setOption({
      tooltip: {
        trigger: 'item',
        formatter: '{b}: {c} ‡∏Ñ‡∏ô ({d}%)'
      },
      legend: {
        orient: 'horizontal',
        bottom: 10,
        textStyle: { color: textColor }
      },
      series: [{
        type: 'pie',
        radius: ['40%', '70%'],
        avoidLabelOverlap: false,
        label: {
          show: true,
          formatter: '{b}\n{c} ‡∏Ñ‡∏ô',
          color: textColor
        },
        emphasis: {
          label: {
            show: true,
            fontSize: 16,
            fontWeight: 'bold'
          }
        },
        data: [
          { value: obesitySick, name: '‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô', itemStyle: { color: '#ffd37a' } },
          { value: dmSick, name: '‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô', itemStyle: { color: '#ff8f8f' } },
          { value: htnSick, name: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô', itemStyle: { color: '#ffb3b3' } }
        ]
      }]
    });
    
    // 4) ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏ô‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á)
    const obesityRisk = state.filtered.filter((r) => {
      const val = norm(r[COL.obesity]);
      return val.includes("‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á") && !val.includes("‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á");
    }).length;
    
    const dmRisk = state.filtered.filter((r) => {
      const val = norm(r[COL.dm]);
      return val.includes("‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á") && !val.includes("‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á");
    }).length;
    
    const htnRisk = state.filtered.filter((r) => {
      const val = norm(r[COL.htn]);
      return val.includes("‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á") && !val.includes("‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á");
    }).length;
    
    window.chRiskStatus.setOption({
      tooltip: {
        trigger: 'item',
        formatter: '{b}: {c} ‡∏Ñ‡∏ô'
      },
      legend: {
        orient: 'horizontal',
        bottom: 10,
        textStyle: { color: textColor }
      },
      series: [{
        type: 'pie',
        radius: ['40%', '70%'],
        avoidLabelOverlap: false,
        label: {
          show: true,
          formatter: '{b}\n{c} ‡∏Ñ‡∏ô',
          color: textColor
        },
        emphasis: {
          label: {
            show: true,
            fontSize: 16,
            fontWeight: 'bold'
          }
        },
        data: [
          { value: obesityRisk, name: '‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô', itemStyle: { color: '#ffd37a' } },
          { value: dmRisk, name: '‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô', itemStyle: { color: '#ff8f8f' } },
          { value: htnRisk, name: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô', itemStyle: { color: '#ffb3b3' } }
        ]
      }]
    });

    window.addEventListener(
      "resize",
      () => {
        window.chFactors.resize();
        window.chTambon.resize();
        window.chSickStatus.resize();
        window.chRiskStatus.resize();
      },
      { once: true }
    );
  }

  function norm(s) {
    return (s || "").toString().trim();
  }

  function countBy(arr, by) {
    return arr.reduce((acc, x) => {
      const k = by(x) || "-";
      acc[k] = (acc[k] || 0) + 1;
      return acc;
    }, {});
  }



  /* ============================================
   Navigation
   ============================================ */
  function initNavigation() {
    const adminLoginBtn = $("admin-login-btn");
    if (adminLoginBtn) {
      adminLoginBtn.onclick = () => {
        // ‡πÅ‡∏™‡∏î‡∏á loading
        adminLoginBtn.disabled = true;
        adminLoginBtn.innerHTML = '<span>‚è≥</span><span>Loading...</span>';
        
        // ‡∏î‡∏∂‡∏á URL ‡∏à‡∏≤‡∏Å server ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° query parameter ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
        google.script.run
          .withSuccessHandler((url) => {
            top.window.location.href = url + "?page=login";
          })
          .withFailureHandler((err) => {
            console.error("Error:", err);
            alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            adminLoginBtn.disabled = false;
            adminLoginBtn.innerHTML = '<span>üîê</span><span>Admin Login</span>';
          })
          .getWebAppUrl();
      };
    }
  }

  /* ============================================
   Utility Functions
   ============================================ */
  function showAlert(el, msg, type) {
    el.textContent = msg;
    el.className = `alert ${type} show`;
  }

  /* ============================================
   Application Initialization
   ============================================ */
  (function () {
    initTheme();
    initNavigation();
    load();
  })();
</script>
