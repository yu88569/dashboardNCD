<script>
  /* ============================================
   Configuration & State
   ============================================ */
  const COL = {
    fname: "à¸Šà¸·à¹ˆà¸­",
    lname: "à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥",
    village: "à¸Šà¸·à¹ˆà¸­à¸«à¸¡à¸¹à¹ˆà¸šà¹‰à¸²à¸™",
    house: "à¸šà¹‰à¸²à¸™à¹€à¸¥à¸‚à¸—à¸µà¹ˆ",
    province: "à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”",
    amphoe: "à¸­à¸³à¹€à¸ à¸­",
    tambon: "à¸•à¸³à¸šà¸¥",
    phone: "à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œ",
    ncd: "à¸ à¸²à¸žà¸£à¸§à¸¡à¸‚à¸­à¸‡à¸à¸²à¸£à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¹‚à¸£à¸„ NCDs",
    obesity: "à¹‚à¸£à¸„à¸­à¹‰à¸§à¸™",
    dm: "à¹‚à¸£à¸„à¹€à¸šà¸²à¸«à¸§à¸²à¸™",
    htn: "à¹‚à¸£à¸„à¸„à¸§à¸²à¸¡à¸”à¸±à¸™à¹‚à¸¥à¸«à¸´à¸•",
    mental: "à¸ªà¸¸à¸‚à¸ à¸²à¸žà¸ˆà¸´à¸•",
    smoke: "à¸ªà¸¹à¸šà¸šà¸¸à¸«à¸£à¸µà¹ˆ",
    alcohol: "à¹à¸­à¸¥à¸à¸­à¸®à¸­à¸¥à¹Œ",
    status: "à¸ªà¸–à¸²à¸™à¸°",
    refer: "à¸ªà¹ˆà¸‡à¸•à¹ˆà¸­à¸«à¸™à¹ˆà¸§à¸¢à¸šà¸£à¸´à¸à¸²à¸£",
    referCode: "à¸£à¸«à¸±à¸ªà¸«à¸™à¹ˆà¸§à¸¢à¸šà¸£à¸´à¸à¸²à¸£à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¸­à¸­à¸",
  };

  const state = {
    raw: [],
    filtered: [],
    options: { province: [], amphoe: [], tambon: [], status: [] },
    filters: { province: "", amphoe: "", tambon: "", status: "" },
  };

  const $ = (id) => document.getElementById(id);

  /* ============================================
   Theme Management
   ============================================ */
  function initTheme() {
    const saved = localStorage.getItem("theme") || "dark";
    applyTheme(saved);

    const btn = $("theme-toggle");
    btn.addEventListener("click", toggleTheme);
  }

  function applyTheme(theme) {
    if (theme === "light") {
      document.body.classList.add("light-theme");
      $("theme-toggle").textContent = "â˜€ï¸";
    } else {
      document.body.classList.remove("light-theme");
      $("theme-toggle").textContent = "ðŸŒ™";
    }
    localStorage.setItem("theme", theme);

    // à¸­à¸±à¸›à¹€à¸”à¸•à¸à¸£à¸²à¸Ÿà¸–à¹‰à¸²à¸¡à¸µ
    if (window.chNcd) updateChartsTheme();
  }

  function toggleTheme() {
    const isLight = document.body.classList.contains("light-theme");
    applyTheme(isLight ? "dark" : "light");
  }

  function updateChartsTheme() {
    if (window.chNcd) {
      window.chNcd.dispose();
      window.chFactors.dispose();
      window.chTambon.dispose();
      window.chNcd = null;
      window.chFactors = null;
      window.chTambon = null;
      drawCharts();
    }
  }

  /* ============================================
   Data Management
   ============================================ */
  function load() {
    google.script.run
      .withSuccessHandler(({ data }) => {
        state.raw = data.map((x) => normalize(x));
        computeOptions();
        applyFilters();
      })
      .withFailureHandler((err) => {
        alert("à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: " + err.message);
        console.error(err);
      })
      .getDataObj();
  }

  function normalize(x) {
    const t = (v) => (v == null ? "" : String(v).trim());
    return {
      ...x,
      [COL.province]: t(x[COL.province]),
      [COL.amphoe]: t(x[COL.amphoe]),
      [COL.tambon]: t(x[COL.tambon]),
      [COL.ncd]: t(x[COL.ncd]),
      [COL.status]: t(x[COL.status]),
      [COL.phone]: t(x[COL.phone]).replace(/[^\d]/g, "").replace(/^0?/, "0"),
    };
  }

  function computeOptions() {
    const uniq = (arr) =>
      Array.from(new Set(arr.filter(Boolean))).sort((a, b) =>
        a.localeCompare(b, "th")
      );
    state.options.province = uniq(state.raw.map((r) => r[COL.province]));
    state.options.amphoe = uniq(state.raw.map((r) => r[COL.amphoe]));
    state.options.tambon = uniq(state.raw.map((r) => r[COL.tambon]));
    state.options.status = uniq(state.raw.map((r) => r[COL.status]));
    fillSelect("f-province", state.options.province);
    fillSelect("f-amphoe", state.options.amphoe);
    fillSelect("f-tambon", state.options.tambon);
    fillSelect("f-status", state.options.status);
  }

  function fillSelect(id, items) {
    const el = $(id);
    el.innerHTML =
      `<option value="">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</option>` +
      items.map((x) => `<option>${x}</option>`).join("");
    el.onchange = () => {
      state.filters[id.split("-")[1]] = el.value;
      applyFilters();
    };
  }

  function applyFilters() {
    const f = state.filters;
    state.filtered = state.raw.filter(
      (r) =>
        (!f.province || r[COL.province] === f.province) &&
        (!f.amphoe || r[COL.amphoe] === f.amphoe) &&
        (!f.tambon || r[COL.tambon] === f.tambon) &&
        (!f.status || r[COL.status] === f.status)
    );

    renderKpis();
    renderTable();
    drawCharts();
  }

  /* ============================================
   UI Rendering
   ============================================ */
  function renderKpis() {
    const total = state.filtered.length;
    const ncdRisk = state.filtered.filter((r) =>
      includesThaiRisk(r[COL.ncd])
    ).length;
    const ncdOk = state.filtered.filter((r) => isThaiNormal(r[COL.ncd])).length;
    const finished = state.filtered.filter((r) =>
      (r[COL.status] || "").includes("à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™")
    ).length;

    $("kpi-total").textContent = total;
    $("kpi-risk").textContent = ncdRisk;
    $("kpi-ok").textContent = ncdOk;
    $("kpi-finish").textContent = finished;
  }

  function isThaiNormal(s) {
    return ["à¸›à¸à¸•à¸´", "à¸›à¸à¸•à¸´ ", " à¸›à¸à¸•à¸´"].includes((s || "").trim());
  }

  function includesThaiRisk(s) {
    return (s || "").includes("à¹€à¸ªà¸µà¹ˆà¸¢à¸‡") || (s || "").includes("à¸ªà¸¹à¸‡");
  }

  function renderTable() {
    const tbody = document.querySelector("#tbl tbody");
    tbody.innerHTML = state.filtered
      .slice(0, 200)
      .map((r) => {
        const n = r[COL.ncd] || "";
        const badge = isThaiNormal(n)
          ? "ok"
          : includesThaiRisk(n)
          ? "warn"
          : "";
        const s = r[COL.status] || "";
        const sbadge = s.includes("à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™") ? "ok" : s ? "warn" : "";
        return `<tr>
        <td>${r[COL.fname] || ""}</td>
        <td>${r[COL.lname] || ""}</td>
        <td>${r[COL.tambon] || ""}</td>
        <td>${r[COL.amphoe] || ""}</td>
        <td>${r[COL.province] || ""}</td>
        <td>${prettyPhone(r[COL.phone])}</td>
        <td><span class="badge ${badge}">${n || "-"}</span></td>
        <td><span class="badge ${sbadge}">${s || "-"}</span></td>
      </tr>`;
      })
      .join("");
  }

  function prettyPhone(p) {
    if (!p) return "-";
    if (p.length === 10)
      return `${p.slice(0, 3)}-${p.slice(3, 6)}-${p.slice(6)}`;
    return p;
  }

  /* ============================================
   Charts
   ============================================ */
  function drawCharts() {
    const el1 = document.getElementById("chart-ncd");
    const el2 = document.getElementById("chart-factors");
    const el3 = document.getElementById("chart-tambon");
    window.chNcd = window.chNcd || echarts.init(el1);
    window.chFactors = window.chFactors || echarts.init(el2);
    window.chTambon = window.chTambon || echarts.init(el3);

    const isDark = !document.body.classList.contains("light-theme");
    const textColor = isDark ? "#e7e9ee" : "#1a1d2e";
    const axisLineColor = isDark ? "#1c2342" : "#d1d5db";

    // 1) à¸ à¸²à¸žà¸£à¸§à¸¡ NCDs
    const ncdCounts = countBy(state.filtered, (r) => norm(r[COL.ncd]));
    window.chNcd.setOption({
      tooltip: { trigger: "axis" },
      textStyle: { color: textColor },
      xAxis: {
        type: "category",
        data: Object.keys(ncdCounts),
        axisLabel: { color: textColor },
        axisLine: { lineStyle: { color: axisLineColor } },
      },
      yAxis: {
        type: "value",
        axisLabel: { color: textColor },
        axisLine: { lineStyle: { color: axisLineColor } },
        splitLine: { lineStyle: { color: axisLineColor } },
      },
      series: [{ type: "bar", data: Object.values(ncdCounts) }],
    });

    // 2) à¸›à¸±à¸ˆà¸ˆà¸±à¸¢à¹€à¸ªà¸µà¹ˆà¸¢à¸‡
    const keys = [
      COL.obesity,
      COL.dm,
      COL.htn,
      COL.mental,
      COL.alcohol,
      COL.smoke,
    ];
    const labels = [
      "à¹‚à¸£à¸„à¸­à¹‰à¸§à¸™",
      "à¹€à¸šà¸²à¸«à¸§à¸²à¸™",
      "à¸„à¸§à¸²à¸¡à¸”à¸±à¸™",
      "à¸ªà¸¸à¸‚à¸ à¸²à¸žà¸ˆà¸´à¸•",
      "à¹à¸­à¸¥à¸à¸­à¸®à¸­à¸¥à¹Œ",
      "à¸ªà¸¹à¸šà¸šà¸¸à¸«à¸£à¸µà¹ˆ",
    ];
    const normal = [],
      risk = [],
      other = [];
    keys.forEach((k, i) => {
      const group = state.filtered.map((r) => norm(r[k]));
      normal.push(group.filter(isThaiNormal).length);
      risk.push(group.filter(includesThaiRisk).length);
      other.push(
        group.filter((s) => s && !isThaiNormal(s) && !includesThaiRisk(s))
          .length
      );
    });
    window.chFactors.setOption({
      tooltip: { trigger: "axis", axisPointer: { type: "shadow" } },
      legend: {
        data: ["à¸›à¸à¸•à¸´", "à¹€à¸ªà¸µà¹ˆà¸¢à¸‡", "à¸­à¸·à¹ˆà¸™ à¹†"],
        textStyle: { color: textColor },
      },
      textStyle: { color: textColor },
      grid: { left: "3%", right: "4%", bottom: "3%", containLabel: true },
      xAxis: {
        type: "category",
        data: labels,
        axisLabel: { color: textColor },
        axisLine: { lineStyle: { color: axisLineColor } },
      },
      yAxis: {
        type: "value",
        axisLabel: { color: textColor },
        axisLine: { lineStyle: { color: axisLineColor } },
        splitLine: { lineStyle: { color: axisLineColor } },
      },
      series: [
        { name: "à¸›à¸à¸•à¸´", type: "bar", stack: "total", data: normal },
        { name: "à¹€à¸ªà¸µà¹ˆà¸¢à¸‡", type: "bar", stack: "total", data: risk },
        { name: "à¸­à¸·à¹ˆà¸™ à¹†", type: "bar", stack: "total", data: other },
      ],
    });

    // 3) Top à¸•à¸³à¸šà¸¥
    const tb = Object.entries(
      countBy(state.filtered, (r) => norm(r[COL.tambon]))
    )
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10);
    window.chTambon.setOption({
      tooltip: { trigger: "axis" },
      textStyle: { color: textColor },
      xAxis: {
        type: "value",
        axisLabel: { color: textColor },
        axisLine: { lineStyle: { color: axisLineColor } },
        splitLine: { lineStyle: { color: axisLineColor } },
      },
      yAxis: {
        type: "category",
        data: tb.map((x) => x[0]).reverse(),
        axisLabel: { color: textColor },
        axisLine: { lineStyle: { color: axisLineColor } },
      },
      series: [{ type: "bar", data: tb.map((x) => x[1]).reverse() }],
    });

    window.addEventListener(
      "resize",
      () => {
        window.chNcd.resize();
        window.chFactors.resize();
        window.chTambon.resize();
      },
      { once: true }
    );
  }

  function norm(s) {
    return (s || "").toString().trim();
  }

  function countBy(arr, by) {
    return arr.reduce((acc, x) => {
      const k = by(x) || "-";
      acc[k] = (acc[k] || 0) + 1;
      return acc;
    }, {});
  }



  /* ============================================
   Navigation
   ============================================ */
  function initNavigation() {
    const adminLoginBtn = $("admin-login-btn");
    if (adminLoginBtn) {
      adminLoginBtn.onclick = () => {
        // à¸”à¸¶à¸‡ URL à¸ˆà¸²à¸ server à¹à¸¥à¸°à¹€à¸žà¸´à¹ˆà¸¡ query parameter
        google.script.run
          .withSuccessHandler((url) => {
            window.location.href = url + "?page=admin";
          })
          .withFailureHandler((err) => {
            console.error("Error:", err);
            // Fallback: à¸¥à¸­à¸‡à¹ƒà¸Šà¹‰ current URL
            const currentUrl = window.location.href.split('?')[0];
            window.location.href = currentUrl + "?page=admin";
          })
          .getWebAppUrl();
      };
    }
  }

  /* ============================================
   Utility Functions
   ============================================ */
  function showAlert(el, msg, type) {
    el.textContent = msg;
    el.className = `alert ${type} show`;
  }

  /* ============================================
   Application Initialization
   ============================================ */
  (function () {
    initTheme();
    initNavigation();
    load();
  })();
</script>
