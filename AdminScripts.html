<script>
  const $ = (id) => document.getElementById(id);

  // SessionId helper (‡∏à‡∏≤‡∏Å URL ‡∏´‡∏£‡∏∑‡∏≠ localStorage)
  function getQueryParam(name) {
    const m = new RegExp('(^|&)' + name + '=([^&]*)').exec(window.location.search.substring(1));
    return m ? decodeURIComponent(m[2]) : null;
  }
  let sessionId = (function () {
    // ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å localStorage ‡∏Å‡πà‡∏≠‡∏ô (‡∏à‡∏≤‡∏Å Login.html)
    try { 
      const sid = localStorage.getItem('ncd_session_id');
      if (sid) {
        console.log("Session ID from localStorage:", sid);
        return sid;
      }
    } catch (_) {}
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å URL
    const sidFromUrl = getQueryParam('sid');
    if (sidFromUrl) {
      try { localStorage.setItem('ncd_session_id', sidFromUrl); } catch (_) {}
      console.log("Session ID from URL:", sidFromUrl);
      return sidFromUrl;
    }
    
    console.warn("No session ID found");
    return null;
  })();

  /* ============================================
   Theme Management
   ============================================ */
  function initTheme() {
    const saved = localStorage.getItem("theme") || "dark";
    applyTheme(saved);

    const btn = $("theme-toggle");
    btn.addEventListener("click", toggleTheme);
  }

  function applyTheme(theme) {
    if (theme === "light") {
      document.body.classList.add("light-theme");
      $("theme-toggle").textContent = "‚òÄÔ∏è";
    } else {
      document.body.classList.remove("light-theme");
      $("theme-toggle").textContent = "üåô";
    }
    localStorage.setItem("theme", theme);
  }

  function toggleTheme() {
    const isLight = document.body.classList.contains("light-theme");
    applyTheme(isLight ? "dark" : "light");
  }

  /* ============================================
   Session Management
   ============================================ */
  let userAmphoe = "";
  let sessionCheckAttempts = 0;
  const MAX_SESSION_CHECK_ATTEMPTS = 3;

  function checkSession() {
    sessionCheckAttempts++;
    console.log("Checking session with sessionId:", sessionId, "attempt:", sessionCheckAttempts);
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ sessionId ‡πÉ‡∏´‡πâ redirect ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (!sessionId) {
      console.error("No session ID found");
      alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Session\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÉ‡∏´‡∏°‡πà");
      google.script.run
        .withSuccessHandler((url) => {
          setTimeout(() => {
            top.window.location.href = url;
          }, 1000);
        })
        .getWebAppUrl();
      return;
    }
    
    // Timeout ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ session
    const timeoutId = setTimeout(() => {
      console.error("Session check timeout");
      if (sessionCheckAttempts < MAX_SESSION_CHECK_ATTEMPTS) {
        console.log("Retrying session check...");
        setTimeout(checkSession, 1000);
      } else {
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ refresh ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (Ctrl+F5)");
      }
    }, 10000); // 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ timeout
    
    google.script.run
      .withSuccessHandler((result) => {
        clearTimeout(timeoutId);
        console.log("Session result:", result);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ result ‡πÄ‡∏õ‡πá‡∏ô null ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!result) {
          console.error("Result is null, attempt:", sessionCheckAttempts);
          
          if (sessionCheckAttempts < MAX_SESSION_CHECK_ATTEMPTS) {
            console.log("Retrying after 1 second...");
            setTimeout(checkSession, 1000);
            return;
          }
          
          // ‡∏•‡πâ‡∏≤‡∏á session ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å
          console.log("Clearing session and redirecting...");
          
          google.script.run
            .withSuccessHandler((result) => {
              // Redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ dashboard
              if (result.redirectUrl) {
                alert("‚ùå Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\n‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Dashboard\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° 'Admin Login'");
                setTimeout(() => {
                  top.window.location.href = result.redirectUrl;
                }, 2000);
              }
            })
            .withFailureHandler(() => {
              alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡πÑ‡∏î‡πâ\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡πÅ‡∏•‡∏∞ Login ‡πÉ‡∏´‡∏°‡πà\n\n‡∏Å‡∏î OK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Dashboard");
              google.script.run
                .withSuccessHandler((url) => {
                  setTimeout(() => {
                    top.window.location.href = url;
                  }, 1000);
                })
                .getWebAppUrl();
            })
            .logout(sessionId);
          return;
        }
        
        if (!result.success) {
          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ session ‡πÉ‡∏´‡πâ‡πÑ‡∏õ login (backend ‡∏à‡∏∞ redirect ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
          console.log("Session check failed:", result.message);
          alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà" + (result.message ? "\n" + result.message : ""));
          
          // Redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ dashboard
          google.script.run
            .withSuccessHandler((url) => {
              top.window.location.href = url;
            })
            .getWebAppUrl();
        } else {
          $("username-display").textContent = result.username;
          userAmphoe = result.amphoe || "";
          
          console.log("User amphoe:", userAmphoe);
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if (!userAmphoe) {
            alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Ç‡∏≠‡∏á admin ‡∏ô‡∏µ‡πâ\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó user ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà");
            $("amphoe-display").textContent = "(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î)";
            $("amphoe-display").style.color = "red";
            $("amphoe-title").textContent = "(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î)";
            return;
          }
          
          // ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÉ‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î
          if ($("amphoe-display")) $("amphoe-display").textContent = userAmphoe;
          if ($("amphoe-title")) $("amphoe-title").textContent = userAmphoe;
          
          // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
          const amphoeInput = $("amphoe-input");
          if (amphoeInput) {
            amphoeInput.value = userAmphoe;
          }
          
          // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          loadData();
        }
      })
      .withFailureHandler((err) => {
        clearTimeout(timeoutId);
        console.error("Session check failed:", err);
        
        if (sessionCheckAttempts < MAX_SESSION_CHECK_ATTEMPTS) {
          console.log("Retrying after error, attempt:", sessionCheckAttempts);
          setTimeout(checkSession, 1000);
          return;
        }
        
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message + "\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà:\n1. Refresh ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (Ctrl+F5)\n2. Logout ‡πÅ‡∏•‡∏∞ Login ‡πÉ‡∏´‡∏°‡πà\n3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Google Apps Script");
        
        // Redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ dashboard
        google.script.run
          .withSuccessHandler((url) => {
            setTimeout(() => {
              top.window.location.href = url;
            }, 2000);
          })
          .getWebAppUrl();
      })
      .checkSession(sessionId);
  }

  function initLogout() {
    $("logout-btn").onclick = () => {
      if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        // ‡πÅ‡∏™‡∏î‡∏á loading
        $("logout-btn").disabled = true;
        $("logout-btn").innerHTML = '<span>‚è≥</span><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...</span>';
        
        google.script.run
          .withSuccessHandler((result) => {
            if (result.success) {
              // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
              alert("‚úÖ " + result.message + "\n\n‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Dashboard...");
              // ‡πÉ‡∏ä‡πâ top.window ‡πÄ‡∏û‡∏∑‡πà‡∏≠ navigate ‡∏ó‡∏±‡πâ‡∏á page
              top.window.location.href = result.redirectUrl;
            } else {
              alert("‚ùå " + result.message);
              $("logout-btn").disabled = false;
              $("logout-btn").innerHTML = '<span>üö™</span><span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>';
            }
          })
          .withFailureHandler((err) => {
            alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            $("logout-btn").disabled = false;
            $("logout-btn").innerHTML = '<span>üö™</span><span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>';
          })
          .logout(sessionId);
      }
    };
  }

  /* ============================================
   Add Record Form
   ============================================ */
  function initAddRecordForm() {
    const modal = $("add-record-modal");
    const form = $("record-form");
    const alert = $("add-record-alert");

    $("add-record-btn").onclick = () => {
      // Reset ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
      form.reset();
      delete form.dataset.editIndex;
      delete form.dataset.editMode;
      
      // ‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
      const fnameInput = form.querySelector(`[name="‡∏ä‡∏∑‡πà‡∏≠"]`);
      const lnameInput = form.querySelector(`[name="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"]`);
      
      if (fnameInput) {
        fnameInput.readOnly = false;
        fnameInput.style.backgroundColor = "";
        fnameInput.style.cursor = "";
      }
      if (lnameInput) {
        lnameInput.readOnly = false;
        lnameInput.style.backgroundColor = "";
        lnameInput.style.cursor = "";
      }
      
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.innerHTML = '<span>üíæ</span><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>';
      submitBtn.style.background = "";
      
      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô header ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
      const modalHeader = modal.querySelector(".modal-header h2");
      if (modalHeader) {
        modalHeader.textContent = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà";
      }
      
      modal.classList.add("show");
    };
    
    $("close-add-record").onclick = closeAddRecordModal;
    $("cancel-add-record").onclick = closeAddRecordModal;

    function closeAddRecordModal() {
      modal.classList.remove("show");
      form.reset();
      alert.className = "alert";
      delete form.dataset.editIndex;
      delete form.dataset.editMode;
      
      // ‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
      const fnameInput = form.querySelector(`[name="‡∏ä‡∏∑‡πà‡∏≠"]`);
      const lnameInput = form.querySelector(`[name="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"]`);
      
      if (fnameInput) {
        fnameInput.readOnly = false;
        fnameInput.style.backgroundColor = "";
        fnameInput.style.cursor = "";
      }
      if (lnameInput) {
        lnameInput.readOnly = false;
        lnameInput.style.backgroundColor = "";
        lnameInput.style.cursor = "";
      }
      
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.innerHTML = '<span>üíæ</span><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>';
      submitBtn.style.background = "";
      
      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô header ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
      const modalHeader = modal.querySelector(".modal-header h2");
      if (modalHeader) {
        modalHeader.textContent = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà";
      }
    }

    form.onsubmit = (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const record = {};
      formData.forEach((val, key) => (record[key] = val));

      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î Edit ‡∏´‡∏£‡∏∑‡∏≠ Add
      const isEditMode = form.dataset.editMode === "true";
      const editIndex = parseInt(form.dataset.editIndex);

      showAlert(alert, isEditMode ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç..." : "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...", "");
      $("submit-record").disabled = true;

      if (isEditMode && !isNaN(editIndex)) {
        // ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ UUID
        const uuid = form.dataset.editUuid;
        
        if (!uuid) {
          showAlert(alert, "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö UUID ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "error");
          $("submit-record").disabled = false;
          return;
        }

        google.script.run
          .withSuccessHandler((result) => {
            if (result.success) {
              showAlert(alert, "‚úÖ " + result.message, "success");
              $("submit-record").disabled = false;
              setTimeout(() => {
                closeAddRecordModal();
                loadData(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
              }, 1500);
            } else {
              showAlert(alert, "‚ùå " + result.message, "error");
              $("submit-record").disabled = false;
            }
          })
          .withFailureHandler((err) => {
            showAlert(alert, "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message, "error");
            $("submit-record").disabled = false;
          })
          .updateRecordByUuid(uuid, record, sessionId);
      } else {
        // ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
        google.script.run
          .withSuccessHandler((result) => {
            if (result.success) {
              showAlert(alert, "‚úÖ " + result.message, "success");
              $("submit-record").disabled = false;
              setTimeout(() => {
                closeAddRecordModal();
                loadData(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
              }, 1500);
            } else {
              showAlert(alert, "‚ùå " + result.message, "error");
              $("submit-record").disabled = false;
            }
          })
          .withFailureHandler((err) => {
            showAlert(alert, "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message, "error");
            $("submit-record").disabled = false;
          })
          .addSingleRecord(record, sessionId);
      }
    };
  }

  /* ============================================
   Import Data
   ============================================ */
  function initImportData() {
    const modal = $("import-modal");
    const fileInput = $("file-input");
    const fileLabel = $("file-label");
    const fileName = $("file-name");
    const fileSelected = $("file-selected");
    const uploadBtn = $("upload-btn");
    const alert = $("import-alert");
    let selectedFile = null;

    $("import-btn").onclick = () => modal.classList.add("show");
    $("close-modal").onclick = closeImportModal;
    $("cancel-btn").onclick = closeImportModal;

    function closeImportModal() {
      modal.classList.remove("show");
      fileInput.value = "";
      fileSelected.classList.remove("show");
      uploadBtn.disabled = true;
      alert.className = "alert";
      selectedFile = null;
    }

    // Download Template
    $("download-template").onclick = () => {
      showAlert(alert, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Template...", "");
      google.script.run
        .withSuccessHandler((result) => {
          if (result.success) {
            showAlert(alert, "‚úÖ " + result.message, "success");
            window.open(result.url, "_blank");
          } else {
            showAlert(alert, "‚ùå " + result.message, "error");
          }
        })
        .withFailureHandler((err) => {
          showAlert(alert, "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message, "error");
        })
        .getTemplateUrl();
    };

    // File Selection
    fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file) handleFileSelect(file);
    };

    // Drag & Drop
    fileLabel.ondragover = (e) => {
      e.preventDefault();
      fileLabel.classList.add("dragover");
    };
    fileLabel.ondragleave = () => fileLabel.classList.remove("dragover");
    fileLabel.ondrop = (e) => {
      e.preventDefault();
      fileLabel.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file) handleFileSelect(file);
    };

    function handleFileSelect(file) {
      const validTypes = [
        "text/csv",
        "application/vnd.ms-excel",
        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      ];
      if (
        !validTypes.includes(file.type) &&
        !file.name.match(/\.(csv|xlsx|xls)$/i)
      ) {
        showAlert(alert, "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏´‡∏£‡∏∑‡∏≠ Excel", "error");
        return;
      }
      selectedFile = file;
      fileName.textContent = `üìÑ ${file.name}`;
      fileSelected.classList.add("show");
      uploadBtn.disabled = false;
      alert.className = "alert";
    }

    // Upload
    uploadBtn.onclick = () => {
      if (!selectedFile) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const content = e.target.result;
        const csvData = selectedFile.name.match(/\.csv$/i)
          ? content
          : parseExcelToCSV(content);

        showAlert(alert, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...", "");
        uploadBtn.disabled = true;

        google.script.run
          .withSuccessHandler((result) => {
            if (result.success) {
              showAlert(
                alert,
                `‚úÖ ${result.message}`,
                "success"
              );
            } else {
              showAlert(alert, "‚ùå " + result.message, "error");
            }
            uploadBtn.disabled = false;
            setTimeout(() => {
              closeImportModal();
              loadData(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
            }, 2000);
          })
          .withFailureHandler((err) => {
            showAlert(alert, "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message, "error");
            uploadBtn.disabled = false;
          })
          .importData(csvData, sessionId);
      };

      if (selectedFile.name.match(/\.csv$/i)) {
        reader.readAsText(selectedFile, "UTF-8");
      } else {
        reader.readAsBinaryString(selectedFile);
      }
    };

    function parseExcelToCSV(data) {
      // Simplified Excel to CSV (‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ library ‡πÄ‡∏ä‡πà‡∏ô SheetJS)
      return data; // Placeholder
    }
  }

  /* ============================================
   Export Data
   ============================================ */
  function initExportData() {
    const exportBtn = $("export-btn");
    if (!exportBtn) return;

    exportBtn.onclick = () => {
      if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏∞‡∏°‡∏µ UUID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ")) {
        return;
      }

      exportBtn.disabled = true;
      exportBtn.innerHTML = '<span>‚è≥</span><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å...</span>';

      const sessionId = localStorage.getItem('ncd_session_id');
      google.script.run
        .withSuccessHandler((result) => {
          exportBtn.disabled = false;
          exportBtn.innerHTML = '<span>üì§</span><span>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>';

          if (result.success) {
            alert("‚úÖ " + result.message + "\n\n‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå...");
            window.open(result.url, "_blank");
          } else {
            alert("‚ùå " + result.message);
          }
        })
        .withFailureHandler((err) => {
          exportBtn.disabled = false;
          exportBtn.innerHTML = '<span>üì§</span><span>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>';
          alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
        })
        .exportDataWithUuid(sessionId);
    };
  }

  /* ============================================
   Data Management
   ============================================ */
  const COL = {
    id: "id",
    fname: "‡∏ä‡∏∑‡πà‡∏≠",
    lname: "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•",
    village: "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô",
    houseNo: "‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà",
    province: "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î",
    amphoe: "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠",
    tambon: "‡∏ï‡∏≥‡∏ö‡∏•",
    phone: "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå",
    ncd: "‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏£‡∏Ñ NCDs",
    obesity: "‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô",
    dm: "‡πÇ‡∏£‡∏Ñ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô",
    htn: "‡πÇ‡∏£‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï",
    mental: "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï",
    smoking: "‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà",
    alcohol: "‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå",
    status: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",
    referral: "‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£",
    referralCode: "‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å",
  };

  let state = {
    raw: [],
    filtered: []
  };

  function loadData() {
    google.script.run
      .withSuccessHandler((result) => {
        console.log("Loaded data:", result);
        
        if (result.error) {
          console.error("Error from server:", result.error);
          alert("‚ùå " + result.error);
          return;
        }
        
        if (result.data && Array.isArray(result.data)) {
          state.raw = result.data.map((x) => normalize(x));
          state.filtered = state.raw;
          console.log("State after normalize:", state);
          renderTable();
        } else {
          console.error("Invalid data format:", result);
          alert("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        }
      })
      .withFailureHandler((err) => {
        console.error("Failed to load data:", err);
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + err.message);
      })
      .getAdminDataObj(sessionId);
  }

  function normalize(row) {
    const t = (x) => (x == null ? "" : String(x).replace(/\s+/g, " ").trim());
    const out = {};
    for (const k in row) {
      const key = t(k);
      out[key] = row[k];
    }
    return out;
  }

  function renderTable() {
    const tbody = document.querySelector("#tbl tbody");
    if (!tbody) {
      console.error("Table body not found");
      return;
    }

    tbody.innerHTML = "";

    console.log("Rendering table with", state.filtered.length, "rows");

    if (state.filtered.length === 0) {
      const tr = document.createElement("tr");
      const msg = !userAmphoe 
        ? "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏µ‡∏ó user" 
        : `‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ "${userAmphoe}"`;
      tr.innerHTML = `<td colspan="20" style="text-align: center; padding: 2rem; color: var(--text-secondary);">${msg}</td>`;
      tbody.appendChild(tr);
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      const totalElement = document.getElementById("total");
      if (totalElement) {
        totalElement.textContent = "0";
      }
      return;
    }

    state.filtered.forEach((row, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${row[COL.fname] || ""}</td>
        <td>${row[COL.lname] || ""}</td>
        <td>${row[COL.village] || ""}</td>
        <td>${row[COL.houseNo] || ""}</td>
        <td>${row[COL.province] || ""}</td>
        <td>${row[COL.amphoe] || ""}</td>
        <td>${row[COL.tambon] || ""}</td>
        <td>${row[COL.phone] || ""}</td>
        <td>${row[COL.ncd] || ""}</td>
        <td>${row[COL.obesity] || ""}</td>
        <td>${row[COL.dm] || ""}</td>
        <td>${row[COL.htn] || ""}</td>
        <td>${row[COL.mental] || ""}</td>
        <td>${row[COL.smoking] || ""}</td>
        <td>${row[COL.alcohol] || ""}</td>
        <td>${row[COL.status] || ""}</td>
        <td>${row[COL.referral] || ""}</td>
        <td>${row[COL.referralCode] || ""}</td>
        <td style="white-space: nowrap;">
          <button class="btn-edit" data-index="${idx}" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" style="padding: 4px 8px; margin-right: 4px; background: var(--border-focus); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
            ‚úèÔ∏è
          </button>
          <button class="btn-delete" data-index="${idx}" title="‡∏•‡∏ö" style="padding: 4px 8px; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
            üóëÔ∏è
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    const totalElement = document.getElementById("total");
    if (totalElement) {
      totalElement.textContent = state.filtered.length;
    }
  }

  /* ============================================
   Utility Functions
   ============================================ */
  function showAlert(el, msg, type) {
    el.textContent = msg;
    el.className = `alert ${type} show`;
  }

  /* ============================================
   CRUD Operations - Edit & Delete
   ============================================ */
  function initCRUD() {
    // ‡πÉ‡∏ä‡πâ event delegation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Edit ‡πÅ‡∏•‡∏∞ Delete
    const tbody = document.querySelector("#tbl tbody");
    if (!tbody) return;

    tbody.addEventListener("click", (e) => {
      const target = e.target;
      
      // ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      if (target.classList.contains("btn-edit") || target.closest(".btn-edit")) {
        const btn = target.classList.contains("btn-edit") ? target : target.closest(".btn-edit");
        const idx = parseInt(btn.dataset.index);
        editRecord(idx);
      }
      
      // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
      if (target.classList.contains("btn-delete") || target.closest(".btn-delete")) {
        const btn = target.classList.contains("btn-delete") ? target : target.closest(".btn-delete");
        const idx = parseInt(btn.dataset.index);
        deleteRecord(idx);
      }
    });
  }

  function editRecord(idx) {
    const row = state.filtered[idx];
    if (!row) {
      alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      return;
    }

    console.log("Editing record:", row);

    // ‡πÄ‡∏õ‡∏¥‡∏î modal ‡∏Å‡πà‡∏≠‡∏ô
    $("add-record-modal").classList.add("show");

    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ name attribute
    const form = $("record-form");
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏ã‡∏ï‡∏Ñ‡πà‡∏≤ ‡πÇ‡∏î‡∏¢‡∏´‡∏≤ input ‡∏à‡∏≤‡∏Å name
    const setValue = (name, value) => {
      const input = form.querySelector(`[name="${name}"]`);
      if (input) {
        input.value = value || "";
      }
    };

    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ï‡∏≤‡∏° COL
    setValue(COL.fname, row[COL.fname]);
    setValue(COL.lname, row[COL.lname]);
    setValue(COL.village, row[COL.village]);
    setValue(COL.houseNo, row[COL.houseNo]);
    setValue(COL.province, row[COL.province]);
    setValue(COL.amphoe, row[COL.amphoe]);
    setValue(COL.tambon, row[COL.tambon]);
    setValue(COL.phone, row[COL.phone]);
    setValue(COL.ncd, row[COL.ncd]);
    setValue(COL.obesity, row[COL.obesity]);
    setValue(COL.dm, row[COL.dm]);
    setValue(COL.htn, row[COL.htn]);
    setValue(COL.mental, row[COL.mental]);
    setValue(COL.smoking, row[COL.smoking]);
    setValue(COL.alcohol, row[COL.alcohol]);
    setValue(COL.status, row[COL.status]);
    setValue(COL.referral, row[COL.referral]);
    setValue(COL.referralCode, row[COL.referralCode]);

    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
    const fnameInput = form.querySelector(`[name="${COL.fname}"]`);
    const lnameInput = form.querySelector(`[name="${COL.lname}"]`);
    const amphoeInput = form.querySelector(`[name="${COL.amphoe}"]`);
    
    if (fnameInput) {
      fnameInput.readOnly = true;
      fnameInput.style.backgroundColor = "var(--bg-secondary)";
      fnameInput.style.cursor = "not-allowed";
    }
    if (lnameInput) {
      lnameInput.readOnly = true;
      lnameInput.style.backgroundColor = "var(--bg-secondary)";
      lnameInput.style.cursor = "not-allowed";
    }
    if (amphoeInput) {
      amphoeInput.readOnly = true;
      amphoeInput.style.backgroundColor = "var(--bg-secondary)";
      amphoeInput.style.cursor = "not-allowed";
    }

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<span>üíæ</span><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>';
    submitBtn.style.background = "#f59e0b";

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô header
    const modalHeader = $("add-record-modal").querySelector(".modal-header h2");
    if (modalHeader) {
      modalHeader.textContent = "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    }

    // ‡πÄ‡∏Å‡πá‡∏ö UUID ‡πÅ‡∏•‡∏∞ index ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    form.dataset.editIndex = idx;
    form.dataset.editUuid = row[COL.id] || "";
    form.dataset.editMode = "true";
  }

  function deleteRecord(idx) {
    const row = state.filtered[idx];
    if (!row) {
      alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      return;
    }

    const uuid = row[COL.id];
    if (!uuid) {
      alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö UUID ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      return;
    }

    const name = `${row[COL.fname] || ""} ${row[COL.lname] || ""}`.trim();
    
    if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`)) {
      return;
    }

    console.log("Deleting record UUID:", uuid);

    // ‡πÅ‡∏™‡∏î‡∏á loading
    const loadingIndicator = $("loading-indicator");
    if (loadingIndicator) {
      loadingIndicator.style.display = "block";
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ UUID
    const sessionId = localStorage.getItem('ncd_session_id');
    google.script.run
      .withSuccessHandler((result) => {
        if (loadingIndicator) {
          loadingIndicator.style.display = "none";
        }

        if (result.success) {
          alert("‚úÖ " + result.message);
          // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
          loadData();
        } else {
          alert("‚ùå " + result.message);
        }
      })
      .withFailureHandler((err) => {
        if (loadingIndicator) {
          loadingIndicator.style.display = "none";
        }
        console.error("Delete failed:", err);
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
      })
      .deleteRecordByUuid(uuid, sessionId);
  }

  /* ============================================
   Debug Functions (Removed - Not Used)
   ============================================ */
  // Debug functions removed as per user request

  /* ============================================
   Application Initialization
   ============================================ */
  (function () {
    initTheme();
    checkSession();
    initLogout();
    initAddRecordForm();
    initImportData();
    initExportData();
    initCRUD();
  })();
</script>
